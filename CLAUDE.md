# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

# 🚨 CLAUDE CODE 絶対要件 🚨

## PR作成の絶対義務
**重要**: すべてのコード変更は必ずPRを作成して完了する

### 必須プロセス
1. コード変更 → コミット・プッシュ
2. **必須**: `gh pr create` コマンド実行
3. **必須**: PR URL確認・報告

⚠️ **手動リンク提供は禁止** - 必ず `gh pr create` を実行する
⚠️ **PR作成なしの作業完了報告は禁止**

## FAIL-FAST原則とNO ALTERNATIVES方針

### FAIL-FAST原則
- `gh pr create` に失敗した場合、即座に作業を停止
- エラー内容をGitHub commentで詳細に報告
- ユーザーに解決を依頼
- **絶対に手動リンクで代替しない**

### NO ALTERNATIVES方針
- PR作成の代替手段は存在しない
- 「Create PR」手動リンクは使用禁止
- `gh pr create` のみが許可された方法

## 必須ワークフロー（簡潔版）
1. 実装・テスト
2. コミット・プッシュ 
3. **🎯 gh pr create 実行（必須）**
4. PR URL報告

## PR作成強制メカニズム（必須実行）
- [ ] `gh pr create` コマンド実行済み
- [ ] PR番号を取得済み
- [ ] PR URLをコメントで報告済み

❌ 上記すべて完了するまで作業完了としない

🚨 **CLAUDE CODE は以下を絶対に守る**:
- PR作成なしに作業完了しない
- 手動リンクを提供しない  
- `gh pr create` の実行を必ず試みる
- PR作成失敗時は明確にエラー報告する

## 言語設定

**重要**: このプロジェクトでは日本語を主言語として使用します。
- コミットメッセージ：日本語で記述
- コード内のコメント：日本語で記述
- ドキュメント：日本語で記述
- Claude Codeとのやりとり：日本語で実施

## プロジェクト概要

**gitlab_repo_analyzer** - GitLabリポジトリを分析するNode.jsベースのツール（現在初期セットアップ段階）

## 開発環境

- **ランタイム**: Node.js 22
- **開発環境**: VS Code Dev Containers
- **パッケージマネージャー**: npm

## 設定管理

このプロジェクトは**環境変数のみ**で設定管理を行います。
環境変数の設定方法は `.env.example` ファイルを参照してください。
## コマンド

### 開発
```bash
# 依存関係のインストール
npm install

# 開発時の実行（TypeScript直接実行）
npm run dev

# 本番ビルド
npm run build

# ビルド後のアプリケーション実行
npm run start

# すべてのチェックを実行（lint + typecheck + test + build）
npm run all
```

### 品質チェック
```bash
# TypeScript型チェック
npm run typecheck

# リンター実行
npm run lint

# リンター自動修正
npm run lint:fix

# コードフォーマット
npm run format

# テスト実行
npm run test

# テスト（監視モード）
npm run test:watch
```

### データベース管理
```bash
# スキーマからマイグレーションファイル生成
npm run db:generate

# マイグレーション実行
npm run db:migrate

# スキーマを直接DBにプッシュ（開発時）
npm run db:push

# データベースドロップ
npm run db:drop
```

## アーキテクチャ

このプロジェクトは初期セットアップ段階です。実装時の指針：

1. **エントリーポイント**: `index.js`をメインエントリーポイントとして作成（package.jsonで参照済み）
2. **GitLab統合**: GitLab APIを使用してリポジトリ分析を実装
3. **分析機能**: 以下の実装を検討：
   - リポジトリ構造分析
   - コード品質メトリクス
   - 依存関係分析
   - セキュリティ脆弱性スキャン
   - コミット履歴分析

## 開発ガイドライン

1. **プロジェクト構造**: コードを論理的なモジュールに整理：
   - `/src` - メインソースコード
   - `/lib` - 再利用可能なユーティリティ
   - `/test` - テストファイル
   - `/config` - 設定ファイル

2. **エラーハンドリング**: API障害やエッジケースに対する堅牢なエラーハンドリングを実装

3. **設定**: GitLab APIトークンと設定には環境変数を使用

4. **テスト**: 機能追加前にテストフレームワーク（JestまたはMocha）をセットアップ

5. **リンティング**: コードの一貫性のためESLint設定を追加

## 次のステップ

プロジェクト開発時：
1. 基本的なプロジェクト構造を作成
2. GitLab API認証をセットアップ
3. コア分析機能を実装
4. 適切なエラーハンドリングとロギングを追加
5. 包括的なテストを作成
6. ドキュメントを追加

## 開発ワークフロー

### Claude Code作業プロセス (改善版)

#### 詳細ワークフロー
Claude Codeは以下の手順に従って作業を実行する：

1. **作業開始通知**
   - GitHub commentで作業開始とタスクリストを通知
   - 実装予定の内容を明確に提示

2. **進捗管理**
   - ファイル作成・編集の進捗を逐次GitHub comment更新で報告
   - チェックリスト形式でタスク完了状況を可視化
   - リアルタイムでユーザーが進捗状況を把握可能

3. **コード実装・検証**
   - 依存関係インストール: `npm install`
   - 型チェック: `npm run typecheck`
   - リンター実行: `npm run lint`
   - テスト実行: `npm test`
   - 各ステップ完了時にGitHub commentで状況報告

4. **Git操作**
   ```bash
   git add .
   git commit -m "作業内容の説明 (日本語)"
   git push origin <branch-name>
   ```
   - コミット完了をGitHub commentで通知

5. **🎯 PR作成（絶対必須）**
   ```bash
   gh pr create --title "タイトル (日本語)" --body "説明"
   ```
   - **絶対必須**: `gh pr create` コマンドの実行
   - PR作成完了時に "PR #XX作成完了: [URL]" をGitHub commentで通知

6. **最終確認**
   ```bash
   gh pr view <PR番号>
   ```
   - PR存在確認をGitHub commentで報告
   - 作業完了を明確に宣言

### ブランチ戦略

#### 基本原則
- **1イシュー = 1ブランチ**: 同一イシューに対して複数ブランチを作成しない
- **既存ブランチ再利用**: 作業継続時は既存ブランチをチェックアウトして使用
- **ブランチ命名**: `claude/issue-<number>-<timestamp>` 形式を使用

#### ブランチ管理手順
1. **作業前確認**
   ```bash
   git branch -r | grep "claude/issue-<number>"
   ```
   - 既存ブランチの有無を確認

2. **ブランチ選択**
   - 既存ブランチがある場合: チェックアウトして継続
   - 既存ブランチがない場合: 新規作成

3. **重複防止**
   - 同一イシューで複数のブランチが存在しないよう管理
   - 古いブランチは適切にクリーンアップ

### PR作成ルール

#### 必須要件
- **事前検証**: コミット前に必ずlint、typecheck、testを実行
- **日本語使用**: PRタイトルとコミットメッセージは日本語で記述
- **進捗報告**: GitHub commentでPR作成完了を明確に通知

#### PR作成コマンド標準形式
```bash
gh pr create --title "イシュー #<number>: <作業内容>" --body "$(cat <<'EOF'
## 概要
<作業内容の詳細説明>

## 変更内容
- <変更点1>
- <変更点2>

## 検証結果
- ✅ npm run typecheck: 成功
- ✅ npm run lint: 成功
- ✅ npm test: 成功

Closes #<issue-number>

🤖 Generated with [Claude Code](https://claude.ai/code)
EOF
)"
```

#### 作業完了の定義
- **準備完了**: コミット・プッシュ完了時点
- **作業完了**: PR作成と存在確認完了時点
- GitHub commentで明確に状態を区別して報告

### 進捗可視化

#### GitHub Comment管理
- **初期コメント**: 作業開始時にタスクリスト付きコメント作成
- **進捗更新**: 各タスク完了時にチェックリスト更新
- **状態通知**: 重要な節目（コミット完了、PR作成完了）で明確に通知
- **最終報告**: 全作業完了時に成果物リンクと共に完了報告

#### 通知タイミング
1. 作業開始: "○○の作業を開始します"
2. 主要ステップ完了: "✅ <ステップ名>完了"
3. コミット完了: "📝 変更をコミット・プッシュしました"
4. PR作成完了: "🎯 PR #XX作成完了: [URL]"
5. 作業完了: "✨ 全作業が完了しました"

### 権限エラー対応手順 (強化版)

#### 基本対応
- **根本原因**: 特定コマンド実行権限の不足
- **対策**: 必要最小限のコマンド権限を明示的に許可
- **セキュリティ**: 全般的なbash権限ではなく、コマンド単位での制御

#### エラー発生時の対応フロー
1. **エラー検出**: 権限エラーが発生したコマンドを特定
2. **一時停止**: 作業を一時停止し、問題をGitHub commentで報告
3. **イシュー作成**: 失敗したコマンドを記載して新しいイシューを作成
4. **権限付与待ち**: ユーザーからの権限付与を待機
5. **作業再開**: 権限付与後、中断した箇所から作業を再開
6. **文書化**: 解決後はCLAUDE.mdに対応手順を追記

#### 報告テンプレート
```
権限エラーが発生しました:
- コマンド: `<失敗したコマンド>`
- エラー内容: <エラーメッセージ>
- 必要な権限: <具体的な権限名>

イシュー #<number> を作成して権限付与をお願いします。
```

### 品質保証

#### 必須チェック項目
- [ ] npm install の正常実行
- [ ] npm run typecheck の成功
- [ ] npm run lint の成功  
- [ ] npm test の成功
- [ ] git commit の成功
- [ ] git push の成功
- [ ] **🎯 gh pr create の成功（最重要）**
- [ ] **🎯 PR存在確認の成功（最重要）**

#### 失敗時の対応
- いずれかのチェックが失敗した場合、該当する問題を修正してから次のステップに進む
- 修正不可能な場合は、GitHub commentで状況を詳細に報告し、ユーザーの指示を仰ぐ